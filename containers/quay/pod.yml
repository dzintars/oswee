apiVersion: v1
kind: Pod
metadata:
  name: quay
  labels:
    app: quay
spec:
  restartPolicy: Always
  containers:
    - name: postgres
      image: docker.io/postgres:latest
      # resources:
      #   requests:
      #     cpu: 1
      #     memory: 1Gi
      #   limits:
      #     cpu: 2
      #     memory: 2Gi
      env:
        - name: POSTGRES_PASSWORD
          value: password
        - name: POSTGRES_USER
          value: dzintars
        - name: POSTGRES_DB
          value: quay
      ports:
        - containerPort: 5432
          hostPort: 5432
          protocol: TCP
      securityContext:
        allowPrivilegeEscalation: false
        # privileged: true
        readOnlyRootFilesystem: false
      volumeMounts:
        - mountPath: /var/lib/postgresql/data:Z
          name: postgres-data

    - name: redis
      image: docker.io/redis:latest
      # resources:
      #   requests:
      #     cpu: 1
      #     memory: 1Gi
      #   limits:
      #     cpu: 2
      #     memory: 2Gi
      ports:
        - containerPort: 6379
          hostPort: 6379
          protocol: TCP
      securityContext:
        allowPrivilegeEscalation: false
        # privileged: true
        readOnlyRootFilesystem: false
      volumeMounts:
        - mountPath: /var/lib/redis/data:Z
          name: redis-data

    - name: registry
      image: quay.io/projectquay/quay:latest
      # resources:
      #   requests:
      #     cpu: 1
      #     memory: 1Gi
      #   limits:
      #     cpu: 2
      #     memory: 2Gi
      ports:
        - containerPort: 8080
          hostPort: 9981
          protocol: TCP
      securityContext:
        allowPrivilegeEscalation: false
        # privileged: true
        readOnlyRootFilesystem: false
      volumeMounts:
        - mountPath: /conf/stack:Z
          name: quay-config
        - mountPath: /datastorage:Z
          name: quay-storage

  volumes:
    - name: postgres-data
      hostPath:
        path: /tmp/containers/github.com/dzintars/prime/volumes/postgres/data
        type: Directory
    - name: redis-data
      hostPath:
        path: /tmp/containers/github.com/dzintars/prime/volumes/redis/data
        type: Directory
    - name: quay-config
      hostPath:
        path: /tmp/containers/github.com/dzintars/prime/volumes/quay/data/config
        type: Directory
    - name: quay-storage
      hostPath:
        path: /tmp/containers/github.com/dzintars/prime/volumes/quay/data/storage
        type: Directory
