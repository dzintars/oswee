---
# configuration tasks file for Libvirt

- name: config | Set the domain socket group ownership to libvirt
  become: true
  ansible.builtin.lineinfile:
    dest: /etc/libvirt/libvirtd.conf
    insertafter: ^#?unix_sock_group = "libvirt"
    line: unix_sock_group = "libvirt"
    state: present
  notify: restart libvirtd

- name: config | Adjust the UNIX socket permissions for the R/W socket
  become: true
  ansible.builtin.lineinfile:
    dest: /etc/libvirt/libvirtd.conf
    insertafter: ^#?unix_sock_rw_perms = "0770"
    line: unix_sock_rw_perms = "0770"
    state: present
  notify: restart libvirtd

# In order to grant qemu access to my users directories i modified /etc/libvirt/qemu.conf file.
# [Link to GitHub](https://github.com/jedi4ever/veewee/issues/996#issuecomment-536519623)
- name: config | Set qemu user in /etc/libvirt/qemu.conf
  become: true
  ansible.builtin.lineinfile:
    dest: /etc/libvirt/qemu.conf
    insertafter: ^#?user = (?!{{ libvirt_system_user }})
    line: user = "{{ libvirt_system_user }}"
    state: present
  notify: restart libvirtd

- name: config | Set qemu group in /etc/libvirt/qemu.conf
  become: true
  ansible.builtin.lineinfile:
    dest: /etc/libvirt/qemu.conf
    insertafter: ^#?group = (?!{{ libvirt_system_user }})
    line: group = "{{ libvirt_system_user }}"
    state: present
  notify: restart libvirtd

  # locate the "nvram" stanza in "/etc/libvirt/qemu.conf", and edit it as follows:
  # nvram = [ "/usr/share/OVMF/OVMF_CODE.fd:/usr/share/OVMF/OVMF_VARS.fd" ]

# - name: config | Enable OVMF
#   ansible.builtin.blockinfile:
#     path: /etc/libvirt/qemu.conf
#     marker: {mark}
#     marker_begin: #nvram = [
#     marker_end: #]
#     block: |-
        # nvram = [
        #   "/usr/share/edk2/ovmf/OVMF_CODE.fd:/usr/share/edk2/ovmf/OVMF_VARS.fd",
        #   "/usr/share/edk2/ovmf/OVMF_CODE.secboot.fd:/usr/share/edk2/ovmf/OVMF_VARS.secboot.fd",
        # ]
#     state: present
  # notify: restart libvirtd
...
