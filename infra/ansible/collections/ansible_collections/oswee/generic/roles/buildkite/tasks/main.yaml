---
# tasks file for Buildkite

- name: install | Copy Buildkite repository
  become: true
  ansible.builtin.copy:
    src: buildkite-agent.repo
    dest: /etc/yum.repos.d/buildkite-agent.repo
    mode: '0644'

- name: install | Ensure config directory exist
  become: true
  ansible.builtin.file:
    path: /etc/buildkite-agent
    state: directory
    mode: '0755'

- name: install | Copy buildkite-agent config template
  become: true
  ansible.builtin.template:
    src: buildkite-agent.cfg.j2
    dest: /etc/buildkite-agent/buildkite-agent.cfg
    mode: '0644'
  # no_log: true

# - name: Debug
#   ansible.builtin.debug:
#     msg: "API_KEY={{ lookup('hashi_vault', 'secret=infra/data/build:buildkite_agent_token')}}"

# TODO: Read the agent key from HashiVault which is stored there by Terraform (this is reference example from the web)
# - name: Ensure API key is present in config file
#   ansible.builtin.lineinfile:
#     path: /etc/app/configuration.ini
#     line: "API_KEY={{ lookup('hashi_vault', 'secret=infra/data/build:buildkite_agent_token')}}"

- name: install| Install Buildkite agent
  become: true
  ansible.builtin.dnf:
    name: buildkite-agent
    state: present

- name: config | Make sure a service is enabled and running
  become: true
  ansible.builtin.systemd:
    name: '{{ buildkite_agent_service_name }}'
    enabled: true
    state: started
...
