---
# tasks file for Vault

- name: install | Install rpm keys
  become: true
  ansible.builtin.rpm_key:
    state: present
    key: '{{ item }}'
  loop:
    - https://rpm.releases.hashicorp.com/gpg

- name: install | Install HashiCorp repository
  become: true
  ansible.builtin.get_url:
    url: https://rpm.releases.hashicorp.com/fedora/hashicorp.repo
    dest: /etc/yum.repos.d/hashicorp.repo

- name: install | Install packages
  become: true
  ansible.builtin.dnf:
    name: '{{ item }}'
    state: present
  loop: '{{ packages.redhat }}'

- name: install | Copy Vault systemd sevice unit
  become: true
  ansible.builtin.copy:
    src: vault.service
    dest: '/etc/systemd/system/{{ vault_service_name }}.service'
    mode: '0644'

- name: install | Force systemd to re-execute itself
  become: true
  ansible.builtin.systemd:
    daemon_reexec: true

- name: install | Create Vault system group
  become: true
  ansible.builtin.group:
    name: '{{ vault_group }}'
    state: present
    system: true

- name: install | Create Vault user
  become: true
  ansible.builtin.user:
    name: '{{ vault_user }}'
    home: '{{ vault_config_path }}'
    system: true
    shell: /bin/false
    group: '{{ vault_group }}'

- name: install | Allow the service to be accessed at the firewall level
  become: true
  ansible.posix.firewalld:
    port: '{{ item }}'
    permanent: true
    state: enabled
  notify: Reload firewalld
  loop:
    - 8200/tcp
    - 8201/tcp

- name: install | Force firewalld reload
  ansible.builtin.meta: flush_handlers

# Actually we don't need to do this because it's done in Systemd unit file.
# - name: install | Set mlock capabilities
#   become: true
#   community.general.capabilities:
#     path: /usr/bin/vault
#     capability: cap_ipc_lock=+ep
#     state: present
...
