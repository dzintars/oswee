---
# tasks/build.yaml file for oswee.generic.libdisplay_info role

- name: build | Meson wipe libdisplay-info
  when: (libdisplay_info_meson_wipe | default(false) | bool)
  ansible.builtin.command: meson setup --wipe build/
  args:
    chdir: '{{ libdisplay_info_source_path }}'

- name: build | Meson build libdisplay-info
  ansible.builtin.command: meson setup build/
  args:
    chdir: '{{ libdisplay_info_source_path }}'

- name: build | Ninja build libdisplay-info
  ansible.builtin.command: ninja -C build/
  args:
    chdir: '{{ libdisplay_info_source_path }}'
    creates:
      - '{{ libdisplay_info_source_path }}/build/libdisplay-info.so'
      - '{{ libdisplay_info_source_path }}/build/libdisplay-info.so.2'

- name: build | Ninja install
  become: true
  ansible.builtin.command: ninja -C build/ install
  args:
    chdir: '{{ libdisplay_info_source_path }}'

- name: build | Ensure library directory exists
  become: true
  ansible.builtin.file:
    path: /usr/local/lib/wlroots
    state: directory
    mode: 0755

- name: build | Copy libdisplay-info shared library module to ldpath
  become: true
  ansible.builtin.copy:
    src: '{{ item }}'
    dest: /usr/local/lib/wlroots
    mode: 0755
    remote_src: true
  loop:
    - '{{ libdisplay_info_source_path }}/build/libdisplay-info.so'
    - '{{ libdisplay_info_source_path }}/build/libdisplay-info.so.2'

- name: build | Create ldconfig wlroots config file
  become: true
  ansible.builtin.copy:
    content: ''
    dest: /etc/ld.so.conf.d/wlroots.conf
    mode: 0644
    force: false

- name: build | Add local libs to ldconfig
  become: true
  ansible.builtin.lineinfile:
    dest: /etc/ld.so.conf.d/wlroots.conf
    line: /usr/local/lib/wlroots

- name: Run ldconfig
  become: true
  ansible.builtin.command: ldconfig
...
