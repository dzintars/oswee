---
# tasks/build.yaml file for oswee.generic.glfw role

- name: build | Generate build files
  ansible.builtin.command: cmake -B build/ -D GLFW_USE_WAYLAND=1 -D BUILD_SHARED_LIBS=ON
  args:
    chdir: '{{ glfw_source_path }}'

- name: build | Build
  community.general.make:
    chdir: '{{ glfw_source_path }}/build'
    target: glfw

- name: build | Ensure shared library directory exists
  become: true
  ansible.builtin.file:
    path: /usr/local/lib
    state: directory
    mode: 0755

- name: build | Copy shared library module and symlinks to ldpath
  become: true
  ansible.builtin.copy:
    src: '{{ item }}'
    dest: /usr/local/lib
    mode: 0755
    remote_src: true
  loop:
    - '{{ glfw_source_path }}/build/src/libglfw.so'
    - '{{ glfw_source_path }}/build/src/libglfw.so.3'
    - '{{ glfw_source_path }}/build/src/libglfw.so.3.4'

- name: build | Create ldconfig config file
  become: true
  ansible.builtin.copy:
    content: ''
    dest: /etc/ld.so.conf.d/extra.conf
    mode: 0644
    force: false

- name: build | Add local libs to ldconfig
  become: true
  ansible.builtin.lineinfile:
    dest: /etc/ld.so.conf.d/extra.conf
    line: /usr/local/lib

- name: build | Run ldconfig
  become: true
  ansible.builtin.command: ldconfig
...
