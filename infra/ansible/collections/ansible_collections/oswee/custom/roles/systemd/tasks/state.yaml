---
# tasks/state.yaml file for oswee.custom.systemd role

# WIP Reference!!!
# NON-INTEGRATED! Don't use until this message is removed!

- name: state | Create a logical volume
  become: true
  community.general.lvol:
    vg: vgdata
    lv: lvterraform
    size: 4096

- name: state | Create a ext4 filesystem on /dev/vgdata/lvterraform
  become: true
  community.general.filesystem:
    fstype: ext4
    dev: /dev/vgdata/lvterraform

- name: state | Ensure Terraform state directory/mount point exists
  become: true
  ansible.builtin.file:
    path: /mnt/data/terraform
    state: directory
    mode: '0755'
    group: dzintars
    owner: dzintars

- name: state | Create SystemD mount unit file for Terraform
  become: true
  ansible.builtin.copy:
    dest: /etc/systemd/system/mnt-data-terraform.mount
    content: |
      [Unit]
      Description=Terraform bootstrap state
      Before=local-fs.target

      [Mount]
      What=/dev/vgdata/lvterraform
      Where=/mnt/data/terraform
      Type=ext4

      [Install]
      WantedBy=local-fs.target

- name: state | Create SystemD mount unit file for registries
  become: true
  ansible.builtin.copy:
    dest: /etc/systemd/system/mnt-data-terraform.mount
    content: |
      [Unit]
      Description=Registries Store
      Before=local-fs.target

      [Mount]
      What=/dev/vgdata/lvregistry
      Where=/mnt/data/registry
      Type=ext4

      [Install]
      WantedBy=local-fs.target

- name: state | Enable and start Terraform mount
  become: true
  ansible.builtin.systemd:
    name: mnt-data-terraform.mount
    daemon_reload: true
    enabled: true
    state: started
...
