---
# tasks file for Vault

# Because of rapid DNS updates local resolver could have outdated cache
# The actual issue is that I am using external DNS service and public TLS certs.
# If would use local TLS most likely i would not have this "DNS race condition"
- name: init | Restart DNS resolver
  become: true
  ansible.builtin.service:
    name: systemd-resolved.service
    state: restarted

- name: init | Create unseal directories
  ansible.builtin.file:
    path: '{{ vault_unseal_keys_path }}'
    state: directory
    # owner: '{{ ansible_user_id }}'
    # group: '{{ ansible_user_id }}'
    mode: '0755'

- name: init | Create root key directories
  ansible.builtin.file:
    path: '{{ vault_root_token_path }}'
    state: directory
    # owner: '{{ ansible_user_id }}'
    # group: '{{ ansible_user_id }}'
    mode: '0755'


- name: init | Check for response
  ansible.builtin.uri:
    url: '{{ vault_url }}'
    return_content: true
    # register: result
    # until: '"Hello World" in result.content'


# TODO: This should be a module
- name: init | Initialise Vault operator
  ansible.builtin.shell: vault operator init -key-shares=5 -key-threshold=3 -format json
  environment:
    VAULT_ADDR: '{{ vault_url }}'
  register: vault_init

- name: init | Parse output of vault init
  ansible.builtin.set_fact:
    vault_init_parsed: '{{ vault_init.stdout | from_json }}'

- name: init | Write unseal keys to files
  no_log: true
  ansible.builtin.copy:
    dest: '{{ vault_unseal_keys_path }}/unseal_key_{{ item.0 }}'
    content: '{{ item.1 }}'
    # owner: '{{ ansible_user_id }}'
    # group: '{{ ansible_user_id }}'
    mode: '0644'
  with_indexed_items: '{{ vault_init_parsed.unseal_keys_hex }}'

- name: init | Write root token to file
  no_log: true
  ansible.builtin.copy:
    content: '{{ vault_init_parsed.root_token }}'
    dest: '{{ vault_root_token_path }}/rootkey'
    # owner: '{{ ansible_user_id }}'
    # group: '{{ ansible_user_id }}'
    mode: '0644'
...
