text
sshpw --username packer --sshkey "ecdsa-sha2-nistp521 AAAAE2VjZHNhLXNoYTItbmlzdHA1MjEAAAAIbmlzdHA1MjEAAACFBAGwrvCrJyfP38lM6YpF49d95ReVT5MYhG9CjkxPidKgpYUI/Lmr8kZ132aEGuugnFOzzol/aPmAIjuXtmzsg8zrSAFuTM3rZY88ZebiNeg+Ywwwsz4/BP8aYXRtiZ/FGcjpVsp+cihiX7rVx5PNFxHcrPdI+aqfcPS5MYxm7ZrRzyaT6w== dzintars@workstation"

url --mirrorlist=https://mirrors.fedoraproject.org/mirrorlist?repo=fedora-$releasever&arch=$basearch
repo --name=updates

keyboard 'us'
lang en_US.UTF-8
bootloader --timeout=1 --append="no_timer_check console=tty1 console=ttyS0,115200n8"
network --bootproto=dhcp --device=link --activate --onboot=on
# `timesource` in Fedora33
timezone America/Los_Angeles --utc --ntpservers=0.pool.ntp.org,1.pool.ntp.org,2.pool.ntp.org,3.pool.ntp.org
firewall --enabled --service=sshd
services --enabled=sshd --disabled=libvrtd,docker,docker-engine
selinux --enforcing

rootpw --lock
user --iscrypted --name vagrant --password $6$rounds=5000$default$L/jbIehFuDL9yFtCbhxk/DrduO/YwFORc8a3AT4.wx3WIFUeMHOS/ihM8uV7Ovi4p571WPJq70t0XJbAwBH83/ --gecos Vagrant --uid 900 --gid 900 --groups wheel
sshkey --username vagrant "ecdsa-sha2-nistp521 AAAAE2VjZHNhLXNoYTItbmlzdHA1MjEAAAAIbmlzdHA1MjEAAACFBAGwrvCrJyfP38lM6YpF49d95ReVT5MYhG9CjkxPidKgpYUI/Lmr8kZ132aEGuugnFOzzol/aPmAIjuXtmzsg8zrSAFuTM3rZY88ZebiNeg+Ywwwsz4/BP8aYXRtiZ/FGcjpVsp+cihiX7rVx5PNFxHcrPdI+aqfcPS5MYxm7ZrRzyaT6w== dzintars@workstation"

zerombr
clearpart --all --initlabel
autopart --noboot --nohome --noswap --nolvm
reboot

%addon org_fedora_oscap
    content-type = scap-security-guide
    profile = pci-dss
%end

%packages --instLangs=en --exclude-weakdeps  # --excludedocs

kernel-core
systemd-udev

# Modifications for @Core
-dracut-config-rescue
-iprutils
-uboot-tools
-kernel
-plymouth
-sssd-kcm
-yum

-plymouth-core-libs
-fedora-release-notes
-mcelog
-smartmontools

# https://pagure.io/fedora-kickstarts/blob/f32/f/fedora-minimal-common.ks#_2
-@standard
-initial-setup-gui
-generic-release*
-glibc-all-langpacks
# recommended by iproute, we don't want it in minimal
-iproute-tc
# recommended by gnutls, we don't want it in minimal
-trousers
glibc-langpack-en

%end

%post --erroronfail
# Give Vagrant user permission to sudo w/o password.
printf -- 'Defaults:vagrant !requiretty\n%%vagrant ALL=(ALL) NOPASSWD: ALL' > /etc/sudoers.d/vagrant
chmod 440 /etc/sudoers.d/vagrant

rm -f /var/lib/systemd/random-seed
rm -f /etc/machine-id
touch /etc/machine-id

# Configure dnf
cat >> /etc/dnf/dnf.conf <<EOF
install_weak_deps=False
fastestmirror=True
repo_gpgcheck=True
timeout=10
EOF

# Clean up
dnf clean all
truncate -c -s 0 /var/log/dnf.log
truncate -c -s 0 /var/log/dnf.librepo.log
truncate -c -s 0 /var/log/dnf.rpm.log
echo "Packages within this image:"
echo "-----------------------------------------------------------------------"
rpm -qa
echo "-----------------------------------------------------------------------"
rm -f /var/lib/rpm/__db*

journalctl --vacuum-time=1s
%end
